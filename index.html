<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QR Pay - PWA Mobile</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0ea5e9"> 
<link rel="icon" href="/app-icon-192.png">
<link rel="apple-touch-icon" href="/app-icon-192.png">

<style>
/* FONT FALLBACK */
:root {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}

/* BASE STYLING */
body {
    margin: 0;
    padding: 0;
    min-height: 100vh;
    background: #f0f4f8; /* Latar belakang lebih lembut */
    color: #1a202c;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
}

/* CARD CONTAINER */
.card {
    background: #ffffff;
    border-radius: 16px; 
    padding: 24px;
    width: 90%;
    max-width: 400px; 
    margin: 20px auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* Bayangan modern */
    box-sizing: border-box;
}

h2 {
    text-align: center;
    font-size: 1.5rem;
    margin-top: 0;
    margin-bottom: 25px;
    color: #0d47a1;
}

/* INPUT & LABEL */
label {
    font-weight: 600;
    margin-top: 15px;
    display: block;
    font-size: 0.95rem;
    color: #4a5568;
}

input {
    width: 100%;
    padding: 14px 10px; /* Area sentuh lebih besar */
    border-radius: 10px;
    border: 1px solid #cbd5e0;
    font-size: 1.1rem;
    background: #f7fafc;
    box-sizing: border-box;
    transition: border-color 0.3s;
}
input:focus {
    border-color: #4299e1;
    outline: none;
}

/* BUTTON UTAMA */
#generateBtn {
    width: 100%; 
    padding: 15px 14px; 
    border-radius: 10px;
    border: 0;
    background: #0ea5e9; /* Warna utama */
    color: white;
    font-weight: 700;
    cursor: pointer;
    margin-top: 30px;
    font-size: 1.1rem;
    box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
    transition: background-color 0.3s, box-shadow 0.3s;
}
#generateBtn:active {
    background: #078dd4; 
    box-shadow: none;
}

/* CANVAS OUTPUT */
#canvasOut {
    display: block;
    margin: 25px auto;
    background: white;
    border-radius: 10px;
    /* Ukuran dasar untuk tampilan browser */
    width: 360px;
    height: 620px; 
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

/* DOWNLOAD & SHARE CONTAINER */
.card > div:last-child {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
    margin-bottom: 10px;
}

/* DOWNLOAD & SHARE BUTTONS */
#downloadBtn, #shareBtn {
    /* Style inline di HTML akan override display:none; ini */
    display: flex !important; 
    align-items: center;
    justify-content: center;
    padding: 12px 18px;
    border-radius: 10px;
    font-weight: 600;
    text-decoration: none;
    font-size: 0.95rem;
    flex-grow: 1; 
    max-width: 180px;
    transition: opacity 0.3s;
}

#downloadBtn {
    background: #2563eb;
    color: white;
}

#shareBtn {
    background: #22c55e;
    color: white;
}

#downloadBtn:active, #shareBtn:active {
    opacity: 0.8;
}
</style>

</head>
<body>

<div class="card">
  <h2>QR Pay - MYDASTERAN</h2>

  <label>Total Tagihan</label>
  <input id="amount" placeholder="15000" type="number" min="1"/>

  <label>Nama Customer</label>
  <input id="customer" placeholder="Nama Customer"/>

  <button id="generateBtn">Buat QRIS</button>

  <canvas id="qrCanvas" width="300" height="300" style="display:none"></canvas>
  <canvas id="canvasOut"></canvas>

  <div style="text-align:center; margin-top:12px;">
    <a id="downloadBtn" download="qris.png"
       style="display:none;background:#2563eb;color:white;padding:12px 18px;border-radius:10px; margin-right:8px;">
       Download
    </a>

    <button id="shareBtn"
            style="display:none;background:#22c55e;color:white;padding:12px 18px;border-radius:10px;">
      WhatsApp
    </button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

<script>
// =====================================================
// PAYLOAD DEFAULT
// ID 010212 (QRIS Dinamis - Nominal Ditetapkan)
// =====================================================
const DEFAULT_PAYLOAD = "00020101021226650013ID.CO.BCA.WWW011893600014000417288002150008850041728800303UMI51440014ID.CO.QRIS.WWW0215ID10254453013320303UMI5204569153033605802ID5911My dasteran6006JEMBER610568162070703A016304E41A";

// =====================================================
// TLV HELPERS
// =====================================================
function parseTLV(p) {
  const o = []; let i = 0;
  while (i + 4 <= p.length) {
    const id = p.substr(i, 2), len = parseInt(p.substr(i + 2, 2));
    if (isNaN(len) || i + 4 + len > p.length) break;
    o.push({ id, value: p.substr(i + 4, len) });
    i += 4 + len;
  }
  return o;
}

function rebuildTLV(a) {
  return a.map(t => t.id + String(t.value.length).padStart(2, '0') + t.value).join('');
}

function crc16(str) {
  let crc = 0xFFFF;
  for (let c of str) {
    crc ^= c.charCodeAt(0) << 8;
    for (let i = 0; i < 8; i++) {
      crc = (crc & 0x8000) ? ((crc << 1) ^ 0x1021) & 0xFFFF : (crc << 1) & 0xFFFF;
    }
  }
  return crc.toString(16).toUpperCase().padStart(4, '0');
}

function addCustomer(p, name) {
  if (!name) return p;
  let tlv = parseTLV(p);
  let idx = tlv.findIndex(t => t.id === "62");
  let sub = idx !== -1 ? parseTLV(tlv[idx].value) : [];
  sub = sub.filter(x => x.id !== "02");
  sub.push({ id: "02", value: name });
  const rebuilt = rebuildTLV(sub);
  if (idx !== -1) tlv[idx].value = rebuilt;
  else tlv.push({ id: "62", value: rebuilt });
  return rebuildTLV(tlv);
}

function setAmount(p, amount) {
  let tlv = parseTLV(p).filter(t => t.id !== "63");
  const i = tlv.findIndex(t => t.id === "54");
  
  // Memastikan nominal adalah bilangan bulat
  const amountStr = String(Math.round(amount)); 
  
  if (i !== -1) tlv[i].value = amountStr;
  else tlv.push({ id: "54", value: amountStr });
  
  const reb = rebuildTLV(tlv);
  return reb + "6304" + crc16(reb + "6304");
}

function formatRp(n) {
  return "Rp " + Number(n).toLocaleString("id-ID");
}

// FUNGSI INTI - Meningkatkan resolusi QR code
function drawQR(text) {
  new QRious({
    element: document.getElementById("qrCanvas"),
    value: text,
    size: 600, // Ukuran digandakan untuk HD
    level: "H"
  });
}

// =====================================================
// BORDER & GRADIENT
// =====================================================
function roundedRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

function drawPremiumBorder(ctx, W) {
  const padding = 20, top = 95, height = 400, radius = 22;
  const x = padding, y = top;
  const w = W - padding * 2, h = height;

  const grad = ctx.createLinearGradient(x, y, x + w, y + h);
  grad.addColorStop(0, "#0ea5e9");
  grad.addColorStop(1, "#1e3a8a");

  ctx.shadowColor = "rgba(14,165,233,0.35)";
  ctx.shadowBlur = 14;

  ctx.strokeStyle = grad;
  ctx.lineWidth = 3;

  roundedRect(ctx, x, y, w, h, radius);
  ctx.stroke();

  ctx.shadowColor = "transparent";
  ctx.shadowBlur = 0;
}

function nominalGradient(ctx, x, y) {
  const g = ctx.createLinearGradient(x - 80, y - 20, x + 80, y + 20);
  g.addColorStop(0, "#1E3A8A");
  g.addColorStop(1, "#0EA5E9");
  return g;
}

// =====================================================
// COMPOSE PNG - Menerapkan faktor skala untuk HD
// =====================================================
async function compose(amountFinal, amountRaw, customer) {
  const qr = document.getElementById("qrCanvas");
  await new Promise(r => requestAnimationFrame(r));

  const out = document.getElementById("canvasOut");
  const ctx = out.getContext("2d");

  // Faktor skala untuk HD
  const scale = 2; 
  const W_base = 360, H_base = 620;

  out.width = W_base * scale;
  out.height = H_base * scale;
  ctx.scale(scale, scale); // Skalakan seluruh konteks

  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, W_base, H_base); 

  drawPremiumBorder(ctx, W_base);

  const logoQris = new Image();
  logoQris.src = "/qris.png";
  await new Promise(r => logoQris.onload = r);

  const logoGpn = new Image();
  logoGpn.src = "/gpn.png";
  await new Promise(r => logoGpn.onload = r);

  // Menggambar dengan koordinat dasar
  ctx.drawImage(logoQris, 18, 22, 120, 40);
  ctx.drawImage(logoGpn, W_base - 18 - 50, 12, 50, 50);

  const qrW_base = 260;
  ctx.drawImage(qr, (W_base - qrW_base) / 2, 105, qrW_base, qrW_base);

  const baseY = 105 + qrW_base + 25;

  ctx.textAlign = "center";
  ctx.fillStyle = "#475569";
  ctx.font = "14px Arial";
  ctx.fillText("Jumlah Tagihan", W_base / 2, baseY);

  const nominalY = baseY + 30;
  ctx.font = "bold 28px Arial";
  ctx.fillStyle = nominalGradient(ctx, W_base / 2, nominalY);
  ctx.fillText(formatRp(amountFinal), W_base / 2, nominalY);

  ctx.font = "12px Arial";
  ctx.fillStyle = "#64748b";
  ctx.fillText(`Termasuk MDR 0.3% (Rp ${Number(amountFinal - amountRaw).toLocaleString("id-ID")})`, W_base / 2, nominalY + 22);

  ctx.fillStyle = "#000";
  ctx.font = "17px Arial";
  ctx.fillText(customer, W_base / 2, nominalY + 55);

  ctx.font = "14px Arial";
  ctx.fillStyle = "#475569";
  ctx.fillText("Merchant: My dasteran - BCA | Jember", W_base / 2, H_base - 85);

  ctx.font = "12px Arial";
  ctx.fillStyle = "#64748b";
  ctx.fillText("Bayar menggunakan aplikasi QRIS Anda", W_base / 2, H_base - 60);
  ctx.fillText("Pastikan nominal sudah sesuai", W_base / 2, H_base - 40);

  return out.toDataURL("image/png");
}

// =====================================================
// BUTTON GENERATE (LOGIKA QRIS TIDAK BERUBAH)
// =====================================================
document.getElementById("generateBtn").addEventListener("click", async () => {
  try {
    // Validasi input (Fungsi tidak berubah)
    const inputAmount = document.getElementById("amount").value.trim();
    const amountRaw = Number(inputAmount);
    const customer = document.getElementById("customer").value.trim();

    if (!amountRaw || isNaN(amountRaw) || amountRaw <= 0) {
      return alert("Nominal wajib diisi dan harus berupa angka positif.");
    }

    // Hitung MDR (Fungsi tidak berubah)
    const mdr = Math.ceil(amountRaw * 0.003); 
    const amountFinal = amountRaw + mdr; 

    // Masukkan amountFinal ke payload QRIS (Fungsi tidak berubah)
    let payload = addCustomer(DEFAULT_PAYLOAD, customer);
    payload = setAmount(payload, amountFinal); 

    drawQR(payload); 

    // Compose PNG
    const png = await compose(amountFinal, amountRaw, customer);

    const dl = document.getElementById("downloadBtn");
    const safeName = customer != ""
      ? "qris_" + customer.replace(/[^a-z0-9]+/gi, "_").toLowerCase() + ".png"
      : "qris.png";

    dl.href = png;
    dl.download = safeName;
    dl.style.display = "flex"; // Menggunakan flex untuk alignment (perbaikan style)

    const s = document.getElementById("shareBtn");
    s.setAttribute("data-filename", safeName);
    s.style.display = "flex"; // Menggunakan flex untuk alignment (perbaikan style)

  } catch (e) {
    alert("Gagal generate: " + e.message);
  }
});

// =====================================================
// SHARE WHATSAPP
// =====================================================
document.getElementById("shareBtn").addEventListener("click", async () => {
  try {
    const dataUrl = document.getElementById("downloadBtn").href;
    const blob = await (await fetch(dataUrl)).blob();

    const fileName = document.getElementById("shareBtn").dataset.filename;
    const file = new File([blob], fileName, { type: "image/png" });

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        title: "QRIS Pembayaran",
        text: "Berikut QRIS pembayaran Anda.",
        files: [file]
      });
      return;
    }

    window.open("https://wa.me/?text=" + encodeURIComponent("Berikut QRIS pembayaran."), "_blank");

  } catch (e) {
    alert("Gagal share: " + e.message);
  }
});
</script>

<script src="/register-service-worker.js"></script>

</body>
</html>


<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QR Pay - PWA Mobile</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3b82f6"> 
<link rel="icon" href="/app-icon-192.png">
<link rel="apple-touch-icon" href="/app-icon-192.png">

<style>
/* FONT FALLBACK */
:root {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}

/* BASE STYLING */
body {
    margin: 0;
    padding: 0;
    min-height: 100vh;
    background: #f4f7f9;
    color: #1f2937;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
}

/* CARD CONTAINER */
.card {
    background: #ffffff;
    border-radius: 20px;
    padding: 30px 24px;
    width: 90%;
    max-width: 400px; 
    margin: 20px auto; /* Margin atas dikurangi agar lebih proporsional */
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
    box-sizing: border-box;
}

h2 {
    text-align: center;
    font-size: 1.6rem;
    margin-top: 0;
    margin-bottom: 28px;
    color: #111827;
    font-weight: 800;
}

/* INPUT & LABEL */
label {
    font-weight: 600;
    margin-top: 20px;
    margin-bottom: 6px;
    display: block;
    font-size: 0.9rem;
    color: #4b5563;
}

input {
    width: 100%;
    padding: 15px 12px;
    border-radius: 12px;
    border: 1px solid #d1d5db;
    font-size: 1.05rem;
    background: #ffffff;
    box-sizing: border-box;
    transition: border-color 0.3s, box-shadow 0.3s;
}
input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    outline: none;
}

/* BUTTON UTAMA (Buat QRIS) */
#generateBtn {
    width: 100%; 
    padding: 16px 14px; 
    border-radius: 12px;
    border: none;
    background: #3b82f6;
    color: white;
    font-weight: 700;
    cursor: pointer;
    margin-top: 30px;
    font-size: 1.1rem;
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    transition: background-color 0.3s, box-shadow 0.3s;
}
#generateBtn:hover {
    background: #2563eb;
}
#generateBtn:active {
    background: #1d4ed8; 
    box-shadow: none;
}

/* --- PERBAIKAN UTAMA DI SINI: CANVAS OUTPUT & CONTAINER --- */
.canvas-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 25px 0; /* Memberikan jarak atas dan bawah */
}

#canvasOut {
    display: block;
    /* Dibuat lebih responsif untuk mobile: ukuran maksimal 90% lebar container */
    max-width: 90%; 
    width: 360px; /* Ukuran default */
    height: 620px; /* Ukuran default */
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
}

/* DOWNLOAD & SHARE CONTAINER */
.action-container {
    display: flex;
    justify-content: space-between; /* Membuat tombol mengisi ruang secara merata */
    gap: 12px;
    margin-top: 20px;
    margin-bottom: 10px;
    width: 100%; /* Memastikan container mengambil lebar penuh card */
}

/* === FULL PREMIUM BUTTON (Glass + Glow + Soft Neu) === */
.action-btn {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;

    padding: 16px;
    border-radius: 16px;
    font-weight: 600;
    font-size: 1rem;
    flex-grow: 1;
    
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.3);

    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);

    box-shadow:
        inset 2px 2px 3px rgba(255, 255, 255, 0.35),
        inset -2px -2px 4px rgba(0, 0, 0, 0.2),
        4px 4px 14px rgba(0,0,0,0.18),
        0 0 18px rgba(255,255,255,0.15);
    
    color: white;
    transition: 0.25s ease;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow:
        inset 2px 2px 3px rgba(255, 255, 255, 0.4),
        inset -2px -2px 4px rgba(0, 0, 0, 0.25),
        6px 6px 18px rgba(0,0,0,0.22),
        0 0 25px rgba(255,255,255,0.25);
}

.action-btn:active {
    transform: scale(0.96);
    box-shadow: none;
}

/* Color Variants */
#downloadBtn {
    background: linear-gradient(135deg, #059669cc, #047857cc);
    border: 1px solid rgba(255,255,255,0.35);
}
#downloadBtn:hover {
    background: linear-gradient(135deg, #06b981ee, #04704fee);
}

#shareBtn {
    background: linear-gradient(135deg, #22c55ecc, #16a34acc);
    border: 1px solid rgba(255,255,255,0.35);
}
#shareBtn:hover {
    background: linear-gradient(135deg, #31d46cee, #189b45ee);
}

/* Icon styling */
.action-btn svg {
    width: 20px;
    height: 20px;
    stroke-width: 2.5;
    transition: 0.25s ease;
}

/* Hover animation icon */
.action-btn:hover svg {
    transform: scale(1.15);
}

/* Glow Rings (modern) */
.action-btn::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    padding: 2px;

    background: linear-gradient(
        135deg,
        rgba(255,255,255,0.4),
        rgba(255,255,255,0.05)
    );

    -webkit-mask:
        linear-gradient(#fff 0 0) content-box,
        linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
            mask-composite: exclude;
    pointer-events: none;
}

</style>

</head>
<body>

<div class="card">
  <h2>QR Pay - MYDASTERAN</h2>

  <label>Total Tagihan (Rp)</label>
  <input id="amount" placeholder="15000" type="number" min="1"/>

  <label>Nama Customer</label>
  <input id="customer" placeholder="Nama Customer"/>

  <button id="generateBtn">Buat QRIS</button>
</div>

<div class="canvas-container">
  <canvas id="qrCanvas" width="300" height="300" style="display:none"></canvas>
  <canvas id="canvasOut"></canvas>

  <div class="action-container" style="max-width: 360px;">
    <a id="downloadBtn" download="qris.png"
   class="action-btn"
   style="display:none;">
   <svg fill="none" stroke="white" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" 
            d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4" />
   </svg>
   Download
</a>

<button id="shareBtn"
        class="action-btn"
        style="display:none;">
    <svg fill="none" stroke="white" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.97-4.03 9-9 9a8.96 8.96 0 01-4-.94L3 21l.94-5A8.96 8.96 0 013 12c0-4.97 4.03-9 9-9s9 4.03 9 9z" />
    </svg>
    WhatsApp
</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

<script>
// =====================================================
// PAYLOAD DEFAULT
// =====================================================
const DEFAULT_PAYLOAD = "00020101021226650013ID.CO.BCA.WWW011893600014000417288002150008850041728800303UMI51440014ID.CO.QRIS.WWW0215ID10254453013320303UMI5204569153033605802ID5911My dasteran6006JEMBER610568162070703A016304E41A";

// =====================================================
// TLV HELPERS (Tidak Berubah)
// =====================================================
function parseTLV(p) {
  const o = []; let i = 0;
  while (i + 4 <= p.length) {
    const id = p.substr(i, 2), len = parseInt(p.substr(i + 2, 2));
    if (isNaN(len) || i + 4 + len > p.length) break;
    o.push({ id, value: p.substr(i + 4, len) });
    i += 4 + len;
  }
  return o;
}

function rebuildTLV(a) {
  return a.map(t => t.id + String(t.value.length).padStart(2, '0') + t.value).join('');
}

function crc16(str) {
  let crc = 0xFFFF;
  for (let c of str) {
    crc ^= c.charCodeAt(0) << 8;
    for (let i = 0; i < 8; i++) {
      crc = (crc & 0x8000) ? ((crc << 1) ^ 0x1021) & 0xFFFF : (crc << 1) & 0xFFFF;
    }
  }
  return crc.toString(16).toUpperCase().padStart(4, '0');
}

function addCustomer(p, name) {
  if (!name) return p;
  let tlv = parseTLV(p);
  let idx = tlv.findIndex(t => t.id === "62");
  let sub = idx !== -1 ? parseTLV(tlv[idx].value) : [];
  sub = sub.filter(x => x.id !== "02");
  sub.push({ id: "02", value: name });
  const rebuilt = rebuildTLV(sub);
  if (idx !== -1) tlv[idx].value = rebuilt;
  else tlv.push({ id: "62", value: rebuilt });
  return rebuildTLV(tlv);
}

function setAmount(p, amount) {
  let tlv = parseTLV(p).filter(t => t.id !== "63");
  const i = tlv.findIndex(t => t.id === "54");
  
  // Memastikan nominal adalah bilangan bulat
  const amountStr = String(Math.round(amount)); 
  
  if (i !== -1) tlv[i].value = amountStr;
  else tlv.push({ id: "54", value: amountStr });
  
  const reb = rebuildTLV(tlv);
  return reb + "6304" + crc16(reb + "6304");
}

function formatRp(n) {
  return "Rp " + Number(n).toLocaleString("id-ID");
}

// FUNGSI INTI - Meningkatkan resolusi QR code (Tidak Berubah)
function drawQR(text) {
  new QRious({
    element: document.getElementById("qrCanvas"),
    value: text,
    size: 600,
    level: "H"
  });
}

// =====================================================
// BORDER & GRADIENT (Tidak Berubah)
// =====================================================
function roundedRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

function drawPremiumBorder(ctx, W) {
  const padding = 20, top = 95, height = 400, radius = 22;
  const x = padding, y = top;
  const w = W - padding * 2, h = height;

  const grad = ctx.createLinearGradient(x, y, x + w, y + h);
  grad.addColorStop(0, "#3b82f6");
  grad.addColorStop(1, "#1e40af");

  ctx.shadowColor = "rgba(59, 130, 246, 0.35)";
  ctx.shadowBlur = 14;

  ctx.strokeStyle = grad;
  ctx.lineWidth = 3;

  roundedRect(ctx, x, y, w, h, radius);
  ctx.stroke();

  ctx.shadowColor = "transparent";
  ctx.shadowBlur = 0;
}

function nominalGradient(ctx, x, y) {
  const g = ctx.createLinearGradient(x - 80, y - 20, x + 80, y + 20);
  g.addColorStop(0, "#1E40AF");
  g.addColorStop(1, "#3B82F6");
  return g;
}

// =====================================================
// COMPOSE PNG (Tidak Berubah)
// =====================================================
async function compose(amountFinal, amountRaw, customer, mdrFinal) {
  const qr = document.getElementById("qrCanvas");
  await new Promise(r => requestAnimationFrame(r));

  const out = document.getElementById("canvasOut");
  const ctx = out.getContext("2d");

  // Faktor skala untuk HD
  const scale = 2; 
  const W_base = 360, H_base = 620;

  out.width = W_base * scale;
  out.height = H_base * scale;
  ctx.scale(scale, scale);

  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, W_base, H_base); 

  drawPremiumBorder(ctx, W_base);

  const logoQris = new Image();
  logoQris.src = "/qris.png";
  await new Promise(r => logoQris.onload = r);

  const logoGpn = new Image();
  logoGpn.src = "/gpn.png";
  await new Promise(r => logoGpn.onload = r);

  // Menggambar dengan koordinat dasar
  ctx.drawImage(logoQris, 18, 22, 120, 40);
  ctx.drawImage(logoGpn, W_base - 18 - 50, 12, 50, 50);

  const qrW_base = 260;
  ctx.drawImage(qr, (W_base - qrW_base) / 2, 105, qrW_base, qrW_base);

  const baseY = 105 + qrW_base + 25;

  ctx.textAlign = "center";
  ctx.fillStyle = "#475569";
  ctx.font = "14px Arial";
  ctx.fillText("Jumlah Tagihan", W_base / 2, baseY);

  const nominalY = baseY + 30;
  ctx.font = "bold 28px Arial";
  ctx.fillStyle = nominalGradient(ctx, W_base / 2, nominalY);
  ctx.fillText(formatRp(amountFinal), W_base / 2, nominalY);

  // LOGIKA TAMPILAN 
  ctx.font = "12px Arial";
  ctx.fillStyle = "#64748b";
  
  let Text;
  if (Final > 0) {
    mdrText = `Termasuk Biaya MDR 0.1% (Rp ${Number(mdrFinal).toLocaleString("id-ID")})`;
  } else {
    mdrText = `Biaya MDR 0% (Gratis Potongan)`;
  }
  
  ctx.fillText(mdrText, W_base / 2, nominalY + 22);

  ctx.fillStyle = "#000";
  ctx.font = "17px Arial";
  ctx.fillText(customer, W_base / 2, nominalY + 55);

  ctx.font = "14px Arial";
  ctx.fillStyle = "#475569";
  ctx.fillText("Merchant: My dasteran - BCA | Jember", W_base / 2, H_base - 85);

  ctx.font = "12px Arial";
  ctx.fillStyle = "#64748b";
  ctx.fillText("Bayar menggunakan aplikasi QRIS Anda", W_base / 2, H_base - 60);
  ctx.fillText("Pastikan nominal sudah sesuai", W_base / 2, H_base - 40);

  return out.toDataURL("image/png");
}

// =====================================================
// BUTTON GENERATE (LOGIKA QRIS DENGAN ATURAN MDR BARU)
// =====================================================
document.getElementById("generateBtn").addEventListener("click", async () => {
  try {
    // Validasi input
    const inputAmount = document.getElementById("amount").value.trim();
    const amountRaw = Number(inputAmount);
    const customer = document.getElementById("customer").value.trim();

    if (!amountRaw || isNaN(amountRaw) || amountRaw <= 0) {
      return alert("Nominal wajib diisi dan harus berupa angka positif.");
    }

    // --- LOGIKA PERHITUNGAN MDR ---
    let mdr = 0;
    const batasMDR0 = 1000000;
    const tarifMDR = 0.0015; // 0.15%

    if (amountRaw > batasMDR0) {
      mdr = Math.ceil(amountRaw * tarifMDR); 
    } else {
      mdr = 0;
    }
    
    const amountFinal = amountRaw + mdr; 
    // --- END LOGIKA PERHITUNGAN MDR ---

    // Masukkan amountFinal ke payload QRIS
    let payload = addCustomer(DEFAULT_PAYLOAD, customer);
    payload = setAmount(payload, amountFinal); 

    drawQR(payload); 

    // Compose PNG (mengirim mdr sebagai argumen)
    const png = await compose(amountFinal, amountRaw, customer, mdr);

    const dl = document.getElementById("downloadBtn");
    const safeName = customer != ""
      ? "qris_" + customer.replace(/[^a-z0-9]+/gi, "_").toLowerCase() + ".png"
      : "qris.png";

    dl.href = png;
    dl.download = safeName;
    dl.style.display = "flex"; 

    const s = document.getElementById("shareBtn");
    s.setAttribute("data-filename", safeName);
    s.style.display = "flex"; 

  } catch (e) {
    alert("Gagal generate: " + e.message);
  }
});

// =====================================================
// SHARE WHATSAPP
// =====================================================
document.getElementById("shareBtn").addEventListener("click", async () => {
  try {
    const dataUrl = document.getElementById("downloadBtn").href;
    const blob = await (await fetch(dataUrl)).blob();

    const fileName = document.getElementById("shareBtn").dataset.filename;
    const file = new File([blob], fileName, { type: "image/png" });

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        title: "QRIS Pembayaran",
        text: "Berikut QRIS pembayaran Anda.",
        files: [file]
      });
      return;
    }

    window.open("https://wa.me/?text=" + encodeURIComponent("Berikut QRIS pembayaran."), "_blank");

  } catch (e) {
    alert("Gagal share: " + e.message);
  }
});
</script>

<script src="/register-service-worker.js"></script>

</body>
</html>


